{% extends 'base.html' %}

{% block title %}
    Reporte de Incidencias
{% endblock %}

{% block poshead %}
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/plugins/bootstrap-datepicker.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/plugins/jquery.timepicker.css' %}">
    <script type="text/javascript" src="{% static 'js/datetime/bootstrap-datepicker.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/datetime/datepair.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/datetime/jquery.datepair.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/datetime/jquery.timepicker.min.js' %}"></script>

    <script type="text/javascript">
        $(document).ready(function()
        {
            $('.dateOnly .date').datepicker(
            {
                    'format': 'yyyy-mm-dd',
                    'autoclose': true
            });

            var dateOnlyEl = document.getElementById('dateOnly');
            var dateOnlyDatepair = new Datepair(dateOnlyEl);
        });

        var materias = { {% for profe in profesores %} '{{ profe.codigo_udg }}': [{% for curso in profe.curso_set.all %} {'id_curso':{{ curso.NRC }}, 'id_materia': '{{ curso.fk_materia.clave }}', 'seccion': '{{ curso.fk_secc }}', 'horario': '{{ curso.fk_horarios.all }}'}{% if not forloop.last %},{% endif %} {% endfor %} ]{% if not forloop.last %},{% endif %} 
        {% endfor %} };

        function filtra_materias(ref)
        {
            sel_listaMat = $('#curso');
            sel_listaMat.empty();

            seleccionada = ref.options[ref.selectedIndex];
            // console.log(seleccionada); // DEBUG

            $(materias[ seleccionada.value ]).each(function() 
            {
                node = document.createElement('option');
                node.value = this.id_curso;
                node.innerHTML = this.id_curso + ' | ' + this.id_materia + ' | ' + this.seccion;

                sel_listaMat.append(node);
            });
            // console.log(sel_listaMat); // DEBUG
        }

    </script>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="medium-11 medium-centered columns panel">
            <form action="/computacion/reporte-incidencias" method="post">{% csrf_token %}
                <fieldset>
                    <legend>Reporte de Incidencias</legend>
                    <div class="row">
                        <div class="medium-3 columns">
                            <label>
                                Fecha <p class="dateOnly" id="dateOnly">
                                <input type="text" id="fecha" class="date error" name="fecha" placeholder="Seleccionar fecha (YYYY-MM-DD)" required/>
                                </p>
                            </label>
                            {% if 'Fecha' in errores %}
                            <small class="error">Fecha invalida</small>
                            {% endif %}
                        </div>
                        <div class="medium-9 columns">
                            <label>
                                Profesor
                                <select name="codigo" id="codigo" onchange="filtra_materias(this)">
                                    <option value="0" disabled="true" selected="true">-- SELECCIONE --</option>
                                    {% for x in profesores %}
                                    <option value="{{ x.codigo_udg }}">{{ x.apellido }}, {{ x.nombre }} ({{ x.codigo_udg }})</option>
                                    {% endfor %}
                                </select>
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="medium-5 columns">
                            <label>
                                Depto. <input type="text" name="depto" placeholder="Departamento" disabled="true" value="{{ departamento.nick|upper }}">
                            </label>
                        </div>
                        <div class="medium-5 columns">
                            <label>
                                NRC | Materia | Secci√≥n
                                <select name="curso" id="curso">
                                    <option value="0" disabled="true" selected="true">-- Seleccione un profesor primero --</option>
                                    <!-- Cursos -->
                                </select>
                            </label>
                            {% if 'Curso' in errores %}
                            <small class="error">Materia invalida</small>
                            {% endif %}
                        </div>
                        <div class="medium-2 columns">
                            <label>
                                Horas falta <input type="text" name="horasFalta" placeholder="Horas falta">
                            </label>
                            {% if 'Hora' in errores %}
                            <small class="error">Hora invalida</small>
                            {% endif %}
                        </div>
                    </div>
                        <input type="submit" value="Enviar Reporte" class="button tiny round">
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
{% endblock %}